import*as s from"fs";import*as e from"path";import{parseJson as a}from"@dcloudio/uni-cli-shared";class r{constructor(s){let{dir:a,uniModules:r}=s;a&&(a=e.resolve(process.env.UNI_INPUT_DIR,a)),r&&(r=r.map((s=>Object.assign(Object.assign({},s),{path:e.resolve(process.env.UNI_INPUT_DIR,`uni_modules/${s.id}/${s.path}`)})))),this.routerDir=a,this.routerFiles=r}getPageJson(r){const t=this.routerDir,o={pages:[],subPackages:[]};if(t&&s.existsSync(t)){let u=s.readdirSync(t);u=u.filter((s=>s.endsWith(".json")));for(const c of u){const u=e.resolve(t,c),g=a(s.readFileSync(u).toString(),!0);r(u),o.pages.push(...g.pages||[]),o.subPackages.push(...g.subPackages||[])}}const u=this.routerFiles,c={pages:[],subPackages:[]};return null==u||u.forEach((e=>{if(s.existsSync(e.path)){const t=function(s,e){return Array.isArray(s.pages)&&s.pages.forEach((s=>{s.path="uni_modules/"+e+"/"+s.path})),Array.isArray(s.subPackages)&&s.subPackages.forEach((s=>{s.root="uni_modules/"+e+"/"+s.root})),s}(a(s.readFileSync(e.path).toString(),!0),e.id);r(e.path),c.pages.push(...t.pages||[]),c.subPackages.push(...t.subPackages||[])}})),{pages:[...o.pages,...c.pages],subPackages:[...o.subPackages,...c.subPackages]}}loader(s,{addDependency:e}){const{pages:a=[],subPackages:r=[]}=this.getPageJson(e);return s.pages=s.pages||[],s.subPackages=s.subPackages||[],s.pages.push(...a),s.subPackages.push(...r),s}}export{r as default};
